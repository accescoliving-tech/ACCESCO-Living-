<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ACCESCO Delivery - Speed Logistics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Montserrat', sans-serif; background-color: #121212; user-select: none; -webkit-user-select: none; touch-action: none; }
        
        /* --- UI LAYER --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; }
        .pointer-events-auto { pointer-events: auto; }

        /* --- FLEET HUB / MENU SCREEN --- */
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* More transparent center to see sky and vehicle clearly */
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.2) 50%, rgba(0, 0, 0, 0.7) 100%);
            z-index: 20; display: flex; flex-direction: column; justify-content: space-between;
            pointer-events: none;
        }

        .garage-header {
            padding: 30px; text-align: center; pointer-events: auto;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            position: relative;
        }
        .garage-title {
            font-family: 'Russo One', sans-serif; font-size: 42px; color: #fc8019;
            text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 4px 15px rgba(252, 128, 25, 0.4); margin: 0;
        }
        .garage-subtitle { color: #fff; font-size: 14px; letter-spacing: 4px; margin-top: 5px; text-transform: uppercase; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .bank-display {
            position: absolute; top: 30px; right: 30px;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px;
            border: 1px solid #ffd700; color: #ffd700; font-family: 'Russo One'; font-size: 18px;
            display: flex; align-items: center; gap: 10px;
        }

        .car-stats-panel {
            position: absolute; top: 140px; left: 30px;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(12px);
            padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            width: 220px;
            pointer-events: none;
        }
        @media (max-width: 600px) {
            .car-stats-panel { top: 120px; left: 50%; transform: translateX(-50%); width: 80%; }
            .garage-title { font-size: 28px; }
            .bank-display { top: 10px; right: 10px; font-size: 14px; }
        }

        .stat-row { margin-bottom: 15px; }
        .stat-label { color: #ccc; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
        .stat-track { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; }
        .stat-val { height: 100%; background: linear-gradient(90deg, #fc8019, #ff9f43); width: 0%; transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .garage-footer {
            background: linear-gradient(to top, rgba(0,0,0,0.8) 20%, transparent);
            padding: 20px 0 60px 0;
            display: flex; flex-direction: column; align-items: center;
            pointer-events: auto;
        }

        .car-carousel {
            display: flex; gap: 20px; overflow-x: auto; padding: 20px 40px;
            width: 100%; max-width: 900px;
            scroll-behavior: smooth;
            justify-content: flex-start;
            scrollbar-width: none;
        }
        .car-carousel::-webkit-scrollbar { display: none; }

        .car-card {
            background: rgba(255, 255, 255, 0.05);
            min-width: 160px; padding: 15px; border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            cursor: pointer; text-align: center;
            backdrop-filter: blur(8px);
            position: relative;
        }
        
        .car-card:hover, .car-card.selected {
            background: rgba(252, 128, 25, 0.2);
            border-color: #fc8019; transform: translateY(-8px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .car-card.locked { opacity: 0.6; filter: grayscale(1); }
        .lock-icon { position: absolute; top: 10px; right: 10px; font-size: 16px; }

        .car-card-name { color: #fff; font-weight: 700; font-size: 14px; margin-bottom: 5px; }
        .car-card-type { color: #ddd; font-size: 10px; text-transform: uppercase; }

        .btn-drive {
            background: linear-gradient(to right, #fc8019, #ff9f43);
            color: white; border: none; padding: 18px 100px;
            font-family: 'Russo One', sans-serif; font-size: 24px; text-transform: uppercase;
            border-radius: 50px; cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 30px rgba(252, 128, 25, 0.4);
            transition: all 0.2s; pointer-events: auto;
        }
        .btn-drive:active { transform: scale(0.95); filter: brightness(1.2); }
        .btn-drive.buy-btn { background: linear-gradient(to right, #27ae60, #2ecc71); box-shadow: 0 0 30px rgba(46, 204, 113, 0.4); }
        .btn-drive:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* --- IN GAME HUD --- */
        #game-hud { display: none; width: 100%; height: 100%; pointer-events: none; position: relative; }

        .hud-top {
            display: flex; justify-content: space-between; padding: 25px; align-items: flex-start;
            position: relative; z-index: 20; 
        }
        
        .stats-box {
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(12px);
            padding: 15px 25px; border-radius: 15px; border-top: 3px solid #fc8019;
            color: white; font-family: 'Russo One', sans-serif;
            display: flex; flex-direction: column; gap: 8px;
            min-width: 150px;
        }

        .hud-row { display: flex; justify-content: space-between; align-items: center; }
        .hud-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .hud-val { font-size: 22px; }

        .fuel-bar-track { width: 100%; height: 6px; background: #222; border-radius: 10px; margin-top: 5px; overflow: hidden; }
        .fuel-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #4cd137, #fc8019); transition: width 0.2s; }

        .hud-controls { display: flex; gap: 15px; pointer-events: auto; }
        .hud-btn {
            background: rgba(0,0,0,0.6); width: 55px; height: 55px; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; color: white; border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; font-size: 22px; transition: all 0.2s;
        }
        .hud-btn:active { transform: scale(0.9); background: #fc8019; }

        .touch-zones { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; pointer-events: auto; z-index: 5; }
        .touch-half { width: 50%; height: 100%; }
        
        #pause-modal, #game-over-modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); align-items: center; justify-content: center; z-index: 30; pointer-events: auto; }
        .modal-card { background: #1a1a1a; padding: 40px; border-radius: 30px; text-align: center; border: 1px solid #333; box-shadow: 0 20px 60px rgba(0,0,0,0.8); width: 85%; max-width: 380px; }
        .modal-title { color: #fff; font-family: 'Russo One'; font-size: 34px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .modal-score { color: #fc8019; font-size: 54px; font-weight: 800; margin: 10px 0 30px 0; }
        .sub-score-label { color: #666; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; font-weight: 800; }

        .hint-text { position: absolute; bottom: 40px; width: 100%; text-align: center; color: rgba(255,255,255,0.6); font-size: 11px; letter-spacing: 3px; font-weight: 800; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #87CEEB;}
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3a40af212a.mp3?filename=fun-life-112188.mp3" type="audio/mpeg">
    </audio>

    <div id="ui-layer">
        
        <div id="menu-screen">
            <div class="garage-header">
                <h1 class="garage-title">ACCESCO DELIVERY</h1>
                <div class="garage-subtitle">Choose Your Premium Fleet</div>
                <div class="bank-display">
                    <span>ðŸª™</span> <span id="bank-val">0</span>
                </div>
            </div>

            <div class="car-stats-panel" id="stats-panel">
                <div class="stat-row">
                    <div class="stat-label">Velocity</div>
                    <div class="stat-track"><div class="stat-val" id="stat-speed"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Agility</div>
                    <div class="stat-track"><div class="stat-val" id="stat-handling"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">Payload</div>
                    <div class="stat-track"><div class="stat-val" id="stat-weight"></div></div>
                </div>
            </div>

            <div class="garage-footer">
                <div class="car-carousel" id="car-list"></div>
                <button class="btn-drive" id="main-btn" onclick="handleMainButton()">START SHIFT</button>
            </div>
        </div>

        <div id="game-hud">
            <div class="touch-zones">
                <div class="touch-half" id="zone-left"></div>
                <div class="touch-half" id="zone-right"></div>
            </div>

            <div class="hud-top">
                <div class="stats-box">
                    <div class="hud-row">
                        <span class="hud-label">LOGS</span>
                        <span class="hud-val" id="dist-val">0m</span>
                    </div>
                    <div class="hud-row">
                        <span class="hud-label">TIPS</span>
                        <span class="hud-val" id="coin-val" style="color: #ffd700;">0</span>
                    </div>
                    <div class="hud-row">
                        <span class="hud-label">ENERGY</span>
                        <span class="hud-val" id="fuel-text">100%</span>
                    </div>
                    <div class="fuel-bar-track">
                        <div class="fuel-bar-fill" id="fuel-bar"></div>
                    </div>
                </div>

                <div class="hud-controls">
                <div class="hud-btn" onclick="toggleMusic()">ðŸ”Š</div>
                <div class="hud-btn" onclick="togglePause()">II</div>
                <div class="hud-btn" onclick="switchCamera()">ðŸ“·</div>
            </div>
        </div>

        <div class="hint-text">TAP SIDES TO NAVIGATE TRAFFIC</div>
    </div>

    <div id="pause-modal">
        <div class="modal-card">
            <div class="modal-title">SHIFT PAUSED</div>
            <button class="btn-drive" onclick="togglePause()" style="padding: 15px 40px; font-size: 18px;">RESUME</button>
            <button class="btn-drive" onclick="resetGame()" style="padding: 15px 40px; font-size: 18px; background: #333; margin-top: 10px; box-shadow: none;">ABORT SHIFT</button>
        </div>
    </div>

    <div id="game-over-modal">
        <div class="modal-card">
            <div class="modal-title" id="go-title-text">SHIFT ENDED</div>
            <div class="sub-score-label">TOTAL DISTANCE</div>
            <div class="modal-score" id="final-score">0m</div>
            <div class="sub-score-label">EARNED TIPS</div>
            <div class="modal-score" style="font-size: 32px; color: #ffd700;" id="final-coins">0</div>
            <button class="btn-drive" onclick="resetGame()" style="padding: 15px 60px; font-size: 20px;">NEW SHIFT</button>
        </div>
    </div>
</div>

<script>
    // --- GAME DATA ---
    const CARS = [
        { name: "Eco Glide", type: "bicycle", color: 0x27ae60, speed: 0.45, handling: 0.95, weight: 0.2, price: 0 },
        { name: "City Scooter", type: "scooter", color: 0xf1c40f, speed: 0.65, handling: 0.8, weight: 0.4, price: 500 },
        { name: "Heavy Loader", type: "loader", color: 0x3498db, speed: 0.55, handling: 0.5, weight: 0.95, price: 1500 },
        { name: "Moto Sport", type: "bike", color: 0xe74c3c, speed: 0.85, handling: 0.7, weight: 0.5, price: 3000 },
        { name: "Express EV-1", type: "ev_bike", color: 0x2ecc71, speed: 0.75, handling: 0.85, weight: 0.6, price: 5000 },
    ];

    let state = {
        mode: 'MENU', 
        carIndex: 0,
        score: 0,
        speed: 0,
        targetSpeed: 0,
        steering: 0, 
        cameraIdx: 0,
        fuel: 100,
        coins: 0,
        musicPlaying: false,
        paused: false,
        totalCoins: parseInt(localStorage.getItem('delivery_total_tips') || '0'),
        ownedCars: JSON.parse(localStorage.getItem('delivery_owned_fleet') || '[0]')
    };

    const CAM_CONFIGS = [
        { name: "Chase", offset: new THREE.Vector3(0, 6, 12), lookAt: new THREE.Vector3(0, 0, 0) },
        { name: "Rider", offset: new THREE.Vector3(0, 2.2, -0.2), lookAt: new THREE.Vector3(0, 1.8, -20) },
        { name: "BirdsEye", offset: new THREE.Vector3(0, 30, 0), lookAt: new THREE.Vector3(0, 0, -5) }
    ];

    const LANE_POSITIONS = [-6, 0, 6];

    let scene, camera, renderer;
    let playerGroup, showroomGroup;
    let roadGroup, roadLines = [], scenery = [], obstacles = [], fuelCans = [], coins = [];
    let buildingTexture, roadTexture;

    function init() {
        document.getElementById('bank-val').innerText = state.totalCoins;
        renderCarList();
        generateBuildingTexture();
        roadTexture = generateRoadTexture();
        setup3D();
        setupControls();
        selectCar(0); 
        animate();
    }

    function renderCarList() {
        const list = document.getElementById('car-list');
        list.innerHTML = '';
        CARS.forEach((car, i) => {
            const el = document.createElement('div');
            const isOwned = state.ownedCars.includes(i);
            el.className = `car-card ${i===state.carIndex ? 'selected' : ''} ${!isOwned ? 'locked' : ''}`;
            el.innerHTML = `
                <div class="car-card-name">${car.name}</div>
                <div class="car-card-type">${isOwned ? 'READY' : car.price + ' TIPS'}</div>
                ${!isOwned ? '<div class="lock-icon">ðŸ”’</div>' : ''}
            `;
            el.onclick = () => selectCar(i);
            list.appendChild(el);
        });
    }

    function selectCar(index) {
        state.carIndex = index;
        renderCarList();
        const car = CARS[index];
        const isOwned = state.ownedCars.includes(index);
        const btn = document.getElementById('main-btn');

        document.getElementById('stat-speed').style.width = (car.speed * 100) + "%";
        document.getElementById('stat-handling').style.width = (car.handling * 100) + "%";
        document.getElementById('stat-weight').style.width = (car.weight * 100) + "%";

        btn.innerText = isOwned ? "START SHIFT" : `UNLOCK FOR ${car.price}`;
        btn.className = isOwned ? "btn-drive" : "btn-drive buy-btn";
        btn.disabled = !isOwned && state.totalCoins < car.price;

        if(showroomGroup) scene.remove(showroomGroup);
        showroomGroup = buildVehicleGeometry(car.type, car.color);
        showroomGroup.position.set(0, 0.5, 0); 
        showroomGroup.rotation.y = Math.PI / 4;
        scene.add(showroomGroup);
        
        // Daylight background for showroom
        if (scene) {
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog.color = new THREE.Color(0x87CEEB);
        }
    }

    function handleMainButton() {
        const index = state.carIndex;
        if (state.ownedCars.includes(index)) {
            launchGame();
        } else {
            const price = CARS[index].price;
            if (state.totalCoins >= price) {
                state.totalCoins -= price;
                state.ownedCars.push(index);
                localStorage.setItem('delivery_total_tips', state.totalCoins);
                localStorage.setItem('delivery_owned_fleet', JSON.stringify(state.ownedCars));
                document.getElementById('bank-val').innerText = state.totalCoins;
                selectCar(index);
            }
        }
    }

    function setupControls() {
        const leftZone = document.getElementById('zone-left');
        const rightZone = document.getElementById('zone-right');
        const handlePress = (key, isPressed) => keys[key] = isPressed;

        const bind = (el, key) => {
            el.addEventListener('touchstart', (e) => { e.preventDefault(); handlePress(key, true); });
            el.addEventListener('touchend', (e) => { e.preventDefault(); handlePress(key, false); });
            el.addEventListener('mousedown', () => handlePress(key, true));
            el.addEventListener('mouseup', () => handlePress(key, false));
        };
        bind(leftZone, 'ArrowLeft');
        bind(rightZone, 'ArrowRight');
    }

    function generateBuildingTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 128; canvas.height = 256;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createLinearGradient(0,0,128,256);
        grad.addColorStop(0, '#7efff5'); // Light cyan
        grad.addColorStop(1, '#4b4b4b');
        ctx.fillStyle = grad; ctx.fillRect(0,0,128,256);
        ctx.fillStyle = '#fff'; 
        for(let y=10; y<256; y+=30) { 
            for(let x=10; x<118; x+=24) {
                if(Math.random()>0.2) {
                    ctx.globalAlpha = 0.3 + Math.random() * 0.7;
                    ctx.fillRect(x, y, 14, 10); 
                }
            }
        }
        buildingTexture = new THREE.CanvasTexture(canvas);
    }

    function generateRoadTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#333333'; 
        ctx.fillRect(0,0,512,512);
        // Add noise/grain
        for(let i=0; i<2000; i++) {
            ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.02})`;
            ctx.fillRect(Math.random()*512, Math.random()*512, 1, 1);
        }
        const tex = new THREE.CanvasTexture(canvas);
        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
        tex.repeat.set(2, 20);
        return tex;
    }

    function setup3D() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); 
        scene.fog = new THREE.Fog(0x87CEEB, 20, 150); 
        camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        
        // Initial setup for camera position so vehicle is visible at start
        camera.position.set(0, 3, 8); 
        camera.lookAt(0, 1, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        const sun = new THREE.DirectionalLight(0xffffff, 1.4);
        sun.position.set(50, 100, 30); sun.castShadow = true;
        sun.shadow.mapSize.width = 1024; sun.shadow.mapSize.height = 1024;
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        
        roadGroup = new THREE.Group();
        roadGroup.visible = false;
        scene.add(roadGroup);
        
        buildRoad(roadGroup);
        for(let i=0; i<60; i++) spawnScenery(true);
    }

    function buildRoad(group) {
        const geo = new THREE.PlaneGeometry(40, 400);
        const mat = new THREE.MeshStandardMaterial({ map: roadTexture, roughness: 0.8 });
        const road = new THREE.Mesh(geo, mat);
        road.rotation.x = -Math.PI/2;
        road.receiveShadow = true; 
        group.add(road);

        const walkGeo = new THREE.BoxGeometry(4, 0.2, 400);
        const walkMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.9 });
        const left = new THREE.Mesh(walkGeo, walkMat); left.position.set(-22, 0.1, 0); group.add(left);
        const right = new THREE.Mesh(walkGeo, walkMat); right.position.set(22, 0.1, 0); group.add(right);

        for(let i=0; i<20; i++) {
            const line = new THREE.Mesh(new THREE.PlaneGeometry(0.6, 12), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 }));
            line.rotation.x = -Math.PI/2; line.position.set(0, 0.05, -200 + i*20); 
            roadLines.push(line);
            group.add(line);
        }
    }

    function buildVehicleGeometry(type, color) {
        const group = new THREE.Group();
        const paintMat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.2, metalness: 0.3 });
        const frameMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.5, metalness: 0.8 });
        const wheelMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.9 });
        const boxMat = new THREE.MeshStandardMaterial({ color: 0xfc8019 }); 
        const lightMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 2 });
        const tailLightMat = new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0xff0000, emissiveIntensity: 1 });

        const addWheel = (x, y, z, r=0.5, w=0.2, detailed=true) => {
            const wheel = new THREE.Mesh(new THREE.CylinderGeometry(r, r, w, detailed?32:16), wheelMat);
            wheel.rotation.z = Math.PI/2;
            wheel.position.set(x, y, z);
            wheel.castShadow = true;
            group.add(wheel);
            if(detailed) {
                const rim = new THREE.Mesh(new THREE.CylinderGeometry(r*0.7, r*0.7, w+0.05, 8), frameMat);
                rim.rotation.z = Math.PI/2; rim.position.set(x,y,z); group.add(rim);
            }
        };

        const addHandlebars = (y, z, w=1.2) => {
            const bar = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, w, 16), frameMat);
            bar.rotation.z = Math.PI/2; bar.position.set(0, y, z); group.add(bar);
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8, 16), frameMat);
            stem.position.set(0, y-0.3, z); group.add(stem);
            const mirrorGeo = new THREE.BoxGeometry(0.2, 0.15, 0.05);
            const m1 = new THREE.Mesh(mirrorGeo, frameMat); m1.position.set(-w/2, y+0.1, z); group.add(m1);
            const m2 = new THREE.Mesh(mirrorGeo, frameMat); m2.position.set(w/2, y+0.1, z); group.add(m2);
        };

        const addCargoBox = (y, z, size=[1.3, 1.3, 1.3]) => {
            const box = new THREE.Mesh(new THREE.BoxGeometry(...size), boxMat);
            box.position.set(0, y, z);
            box.castShadow = true;
            group.add(box);
            const stripe = new THREE.Mesh(new THREE.BoxGeometry(size[0]+0.05, size[1]*0.2, size[2]+0.05), frameMat);
            stripe.position.set(0, y, z); group.add(stripe);
        };

        const addHeadlight = (y, z) => {
            const h = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), lightMat);
            h.scale.set(1, 1, 0.5); h.position.set(0, y, z); group.add(h);
            const pl = new THREE.PointLight(0xffffff, 0.8, 15); pl.position.set(0, y, z-1); group.add(pl);
        };

        if(type === 'bicycle') {
            const mainFrame = new THREE.Mesh(new THREE.TorusGeometry(0.8, 0.05, 8, 4), frameMat);
            mainFrame.rotation.y = Math.PI/2; mainFrame.position.y = 1.0; group.add(mainFrame);
            addWheel(0, 0.5, -0.9, 0.5, 0.1);
            addWheel(0, 0.5, 0.9, 0.5, 0.1);
            addHandlebars(1.6, -0.8, 1.0);
            addCargoBox(1.6, 0.8, [0.8, 1.0, 0.8]);
            const seat = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.1, 0.6), wheelMat);
            seat.position.set(0, 1.4, 0.1); group.add(seat);
        } 
        else if(type === 'scooter') {
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.0, 0.5, 2.5), paintMat);
            body.position.y = 0.5; body.castShadow = true; group.add(body);
            const frontWall = new THREE.Mesh(new THREE.BoxGeometry(1.0, 1.2, 0.3), paintMat);
            frontWall.position.set(0, 1.0, -1.0); group.add(frontWall);
            addWheel(0, 0.4, -0.8, 0.4, 0.4);
            addWheel(0, 0.4, 0.8, 0.4, 0.4);
            addHandlebars(1.5, -1.0, 1.2);
            addHeadlight(1.0, -1.2);
            addCargoBox(1.4, 0.6, [1.1, 1.0, 1.1]);
        }
        else if(type === 'loader') {
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.8, 1.4), paintMat);
            cabin.position.set(0, 1.1, -1.1); cabin.castShadow = true; group.add(cabin);
            const glass = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.8, 0.1), frameMat);
            glass.position.set(0, 1.4, -1.81); group.add(glass);
            const bed = new THREE.Mesh(new THREE.BoxGeometry(2.0, 1.6, 2.2), boxMat);
            bed.position.set(0, 1.0, 0.7); bed.castShadow = true; group.add(bed);
            addWheel(0, 0.5, -1.2, 0.5, 0.5); 
            addWheel(-1.0, 0.5, 1.1, 0.5, 0.5); 
            addWheel(1.0, 0.5, 1.1, 0.5, 0.5);
            addHeadlight(0.8, -1.8);
        }
        else { 
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 2.6), paintMat);
            body.position.y = 0.9; body.castShadow = true; group.add(body);
            addWheel(0, 0.6, -1.1, 0.6, 0.5);
            addWheel(0, 0.6, 1.1, 0.6, 0.5);
            addHandlebars(1.6, -1.0, 1.3);
            addHeadlight(1.2, -1.4);
            addCargoBox(1.7, 0.9, [1.0, 0.8, 1.0]);
            const tl = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.1), tailLightMat);
            tl.position.set(0, 1.4, 1.3); group.add(tl);
        }

        const rider = new THREE.Group();
        const suitMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
        const visorMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0, metalness: 1 });
        const torso = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.9, 0.4), suitMat);
        torso.position.y = 1.45; rider.add(torso);
        const helmet = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), paintMat);
        helmet.position.y = 2.05; rider.add(helmet);
        const visor = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), visorMat);
        visor.scale.set(1.1, 0.5, 1.1); visor.position.set(0, 2.1, -0.1); rider.add(visor);
        const armGeo = new THREE.CylinderGeometry(0.08, 0.08, 0.7);
        const leftArm = new THREE.Mesh(armGeo, suitMat);
        leftArm.position.set(-0.45, 1.6, -0.3); leftArm.rotation.x = -Math.PI/3; rider.add(leftArm);
        const rightArm = new THREE.Mesh(armGeo, suitMat);
        rightArm.position.set(0.45, 1.6, -0.3); rightArm.rotation.x = -Math.PI/3; rider.add(rightArm);
        const legGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.8);
        const leftLeg = new THREE.Mesh(legGeo, suitMat);
        leftLeg.position.set(-0.3, 0.8, 0); leftLeg.rotation.x = Math.PI/6; rider.add(leftLeg);
        const rightLeg = new THREE.Mesh(legGeo, suitMat);
        rightLeg.position.set(0.3, 0.8, 0); rightLeg.rotation.x = Math.PI/6; rider.add(rightLeg);
        rider.position.z = -0.2;
        group.add(rider);

        return group;
    }

    function createEnergyCell() {
        const group = new THREE.Group();
        const cellMat = new THREE.MeshStandardMaterial({ color: 0x4cd137, emissive: 0x4cd137, emissiveIntensity: 0.8 });
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.2, 6), cellMat);
        body.position.y = 0; group.add(body);
        const core = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1.4, 6), new THREE.MeshBasicMaterial({color: 0xffffff}));
        group.add(core);
        const light = new THREE.PointLight(0x4cd137, 2, 10); group.add(light);
        group.position.y = 1.5;
        return group;
    }

    function createGoldTip() {
        const group = new THREE.Group();
        const geo = new THREE.TorusGeometry(0.6, 0.15, 12, 24); 
        const mat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 1, roughness: 0.1, emissive: 0xffd700, emissiveIntensity: 0.3 });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.rotateY(Math.PI/2);
        group.add(mesh);
        const center = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 0.05, 16), mat);
        center.rotateX(Math.PI/2); group.add(center);
        const light = new THREE.PointLight(0xffd700, 2, 8); group.add(light);
        group.position.y = 2.5; 
        return group;
    }

    function spawnScenery(randomZ) {
        const xSide = Math.random()>0.5 ? 1 : -1;
        const x = xSide * (28 + Math.random()*20); 
        const z = randomZ ? -100 + Math.random()*200 : -200;
        const h = 15 + Math.random()*40;
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(12, h, 12), new THREE.MeshStandardMaterial({ map: buildingTexture, roughness: 0.7 }));
        mesh.position.set(x, h/2, z);
        mesh.castShadow = true; mesh.receiveShadow = true;
        roadGroup.add(mesh); scenery.push(mesh);
    }

    function spawnObstacle() {
        const lane = LANE_POSITIONS[Math.floor(Math.random()*3)];
        const obs = buildVehicleGeometry('scooter', 0x333333);
        obs.children.forEach(c => { if(c.type === "Group") obs.remove(c); });
        obs.position.set(lane, 0, -200);
        obs.userData = { speed: 0.2 + Math.random()*0.4 };
        scene.add(obs); obstacles.push(obs);
    }

    function spawnEnergy() {
        const lane = LANE_POSITIONS[Math.floor(Math.random()*3)];
        const c = createEnergyCell(); c.position.set(lane, 0, -200);
        scene.add(c); fuelCans.push(c);
    }

    function spawnTip() {
        const lane = LANE_POSITIONS[Math.floor(Math.random()*3)];
        const c = createGoldTip(); c.position.set(lane, 0, -200); 
        scene.add(c); coins.push(c);
    }

    function toggleMusic() {
        const audio = document.getElementById('bg-music');
        if (state.musicPlaying) audio.pause(); else audio.play().catch(e => {});
        state.musicPlaying = !state.musicPlaying;
    }

    function launchGame() {
        if(state.mode === 'GAME') return;
        if(showroomGroup) scene.remove(showroomGroup);
        roadGroup.visible = true;
        
        // Ensure background remains daylight
        scene.background = new THREE.Color(0x87CEEB); 
        scene.fog.color = new THREE.Color(0x87CEEB);

        const carData = CARS[state.carIndex];
        if(playerGroup) scene.remove(playerGroup);
        playerGroup = buildVehicleGeometry(carData.type, carData.color);
        scene.add(playerGroup);

        state.score = 0; state.speed = 0; state.fuel = 100; state.coins = 0;
        state.mode = 'GAME'; state.paused = false;

        document.getElementById('coin-val').innerText = "0";
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-hud').style.display = 'block';
    }

    function resetGame() {
        state.mode = 'MENU';
        roadGroup.visible = false;
        if(playerGroup) scene.remove(playerGroup);
        obstacles.forEach(o => scene.remove(o)); obstacles = [];
        fuelCans.forEach(f => scene.remove(f)); fuelCans = [];
        coins.forEach(c => scene.remove(c)); coins = [];
        
        // Reset camera for showroom visibility
        camera.position.set(0, 3, 8); 
        camera.lookAt(0, 1, 0);
        
        selectCar(state.carIndex);
        document.getElementById('game-hud').style.display = 'none';
        document.getElementById('pause-modal').style.display = 'none';
        document.getElementById('game-over-modal').style.display = 'none';
        document.getElementById('menu-screen').style.display = 'flex';
    }

    function togglePause() {
        if(state.mode !== 'GAME') return;
        state.paused = !state.paused;
        document.getElementById('pause-modal').style.display = state.paused ? 'flex' : 'none';
    }

    function switchCamera() { state.cameraIdx = (state.cameraIdx + 1) % CAM_CONFIGS.length; }

    function update() {
        const time = Date.now() * 0.005;

        if(state.mode === 'MENU') { 
            if(showroomGroup) {
                showroomGroup.rotation.y += 0.012; 
                showroomGroup.position.y = 0.5 + Math.sin(time) * 0.08;
            }
            return; 
        }

        if(state.mode !== 'GAME' || state.paused) return;

        const carBaseSpeed = CARS[state.carIndex].speed;
        state.targetSpeed = carBaseSpeed * (1 + state.score/20000);
        state.speed += (state.targetSpeed - state.speed) * 0.04;
        state.score += state.speed;
        state.fuel -= 0.014 + (state.speed * 0.04);

        if(state.fuel <= 0) {
            state.mode = 'OVER';
            document.getElementById('go-title-text').innerText = "POWER DEPLETED";
            document.getElementById('final-score').innerText = Math.floor(state.score)+"m";
            document.getElementById('final-coins').innerText = state.coins;
            document.getElementById('game-over-modal').style.display = 'flex';
            state.totalCoins += state.coins;
            localStorage.setItem('delivery_total_tips', state.totalCoins);
        }

        document.getElementById('dist-val').innerText = Math.floor(state.score) + "m";
        document.getElementById('fuel-text').innerText = Math.floor(state.fuel) + "%";
        document.getElementById('fuel-bar').style.width = Math.max(0, state.fuel) + "%";

        if(keys.ArrowLeft) state.steering = Math.max(-1, state.steering - 0.12);
        else if(keys.ArrowRight) state.steering = Math.min(1, state.steering + 0.12);
        else state.steering *= 0.85;

        if(playerGroup) {
            playerGroup.position.x += state.steering * 0.45 * (1 + state.speed);
            playerGroup.rotation.y = -state.steering * 0.15;
            playerGroup.rotation.z = -state.steering * 0.35; 
            playerGroup.position.x = Math.max(-14, Math.min(14, playerGroup.position.x));

            const cfg = CAM_CONFIGS[state.cameraIdx];
            const ideal = cfg.offset.clone().add(new THREE.Vector3(playerGroup.position.x * 0.5, 0, 0));
            camera.position.lerp(ideal, 0.1);
            camera.lookAt(playerGroup.position.x * 0.5, 1.5, playerGroup.position.z - 8);
        }

        roadLines.forEach(l => { l.position.z += state.speed * 5; if(l.position.z > 20) l.position.z = -200; });
        scenery.forEach((s, i) => { s.position.z += state.speed * 5; if(s.position.z > 20) { roadGroup.remove(s); scenery.splice(i, 1); spawnScenery(); } });

        if(Math.random() < 0.02) spawnTip();
        if(Math.random() < 0.007) spawnEnergy();
        if(Math.random() < 0.018) spawnObstacle();

        obstacles.forEach((o, i) => {
            o.position.z += (state.speed * 5) - o.userData.speed;
            if(Math.abs(o.position.z - playerGroup.position.z) < 3 && Math.abs(o.position.x - playerGroup.position.x) < 1.6) {
                state.mode = 'OVER';
                document.getElementById('go-title-text').innerText = "COLLISION DETECTED";
                document.getElementById('final-score').innerText = Math.floor(state.score)+"m";
                document.getElementById('final-coins').innerText = state.coins;
                document.getElementById('game-over-modal').style.display = 'flex';
                state.totalCoins += state.coins;
                localStorage.setItem('delivery_total_tips', state.totalCoins);
            }
            if(o.position.z > 20) { scene.remove(o); obstacles.splice(i, 1); }
        });

        fuelCans.forEach((f, i) => {
            f.position.z += state.speed * 5; 
            f.rotation.y += 0.08;
            f.position.y = 1.2 + Math.sin(time + 1.5) * 0.4;
            if(Math.abs(f.position.z - playerGroup.position.z) < 3.5 && Math.abs(f.position.x - playerGroup.position.x) < 2.2) {
                state.fuel = Math.min(100, state.fuel + 25); scene.remove(f); fuelCans.splice(i,1);
            } else if(f.position.z > 20) { scene.remove(f); fuelCans.splice(i,1); }
        });

        coins.forEach((c, i) => {
            c.position.z += state.speed * 5; 
            c.rotation.y += 0.12;
            c.position.y = 2.2 + Math.sin(time) * 0.5;
            if(Math.abs(c.position.z - playerGroup.position.z) < 3.5 && Math.abs(c.position.x - playerGroup.position.x) < 2.2) {
                state.coins++; document.getElementById('coin-val').innerText = state.coins;
                scene.remove(c); coins.splice(i,1);
            } else if(c.position.z > 20) { scene.remove(c); coins.splice(i,1); }
        });
    }

    const keys = { ArrowLeft:false, ArrowRight:false };
    window.onkeydown = e => { if(e.code in {ArrowLeft:1, ArrowRight:1, KeyA:1, KeyD:1}) keys[e.code.includes('Left')||e.code.includes('A')?'ArrowLeft':'ArrowRight'] = true; };
    window.onkeyup = e => { if(e.code in {ArrowLeft:1, ArrowRight:1, KeyA:1, KeyD:1}) keys[e.code.includes('Left')||e.code.includes('A')?'ArrowLeft':'ArrowRight'] = false; };

    function animate() { requestAnimationFrame(animate); update(); renderer.render(scene, camera); }
    window.onresize = () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); };

    init();
</script>
</body>
</html>
