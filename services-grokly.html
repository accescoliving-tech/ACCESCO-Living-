<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Grokly Market | Fresh & Fast</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="./services-grokly-style/style.css">
<link rel="stylesheet" href="./services-grokly-style/media.css">

<style>
  :root { 
    --primary: #27ae60; 
    --primary-light: #eafaf1;
    --dark: #1a1a1a; 
    --gray: #f4f4f4;
    --text-muted: #717171;
    --shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  /* --- Improved Grid Layout --- */
  .market-feed {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .feed-section { margin-bottom: 40px; }
  
  .feed-title {
    font-family: 'Outfit', sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Grid instead of horizontal scroll for better visibility */
  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
  }

  /* --- Modern Product Cards --- */
  .product-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #eee;
    display: flex;
    flex-direction: column;
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  .p-img-wrapper {
    width: 100%;
    aspect-ratio: 1 / 1;
    background: var(--gray);
    overflow: hidden;
    position: relative;
  }

  .p-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: scale 0.5s ease;
  }

  .product-card:hover .p-img { scale: 1.1; }

  .p-info {
    padding: 15px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .p-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 4px;
    color: var(--dark);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 2.4em;
  }

  .p-meta {
    font-weight: 800;
    color: var(--primary);
    font-size: 1.1rem;
    margin-top: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .add-btn {
    background: var(--primary-light);
    color: var(--primary);
    border: none;
    padding: 6px 16px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
  }

  .add-btn:hover {
    background: var(--primary);
    color: white;
  }

  /* Success Toast & Processing */
  .checkout-btn:disabled { background: #ccc; cursor: not-allowed; }
  .success-toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--primary); color: white; padding: 16px 32px;
    border-radius: 50px; z-index: 3000; display: none;
    box-shadow: 0 10px 25px rgba(39, 174, 96, 0.3);
    font-weight: 600; animation: slideUp 0.3s ease-out;
  }
  @keyframes slideUp { from { bottom: -50px; opacity: 0; } to { bottom: 30px; opacity: 1; } }
  .order-processing { opacity: 0.5; pointer-events: none; filter: grayscale(0.5); }
</style>
</head>

<body>
<main>
<header class="main-header">
  <div class="header-container">
    <div class="header-top">
      <div class="brand">
        <img src="./images/grokerly_logo.png" alt="Grokly Logo" class="logo">
        <h1 class="brand-name">Grokly</h1>
      </div>
      <div class="location-wrapper">
        <button class="address-btn" id="addressBtn">
          <i class="ri-map-pin-line"></i>
          <span class="addr-display" id="addrDisplay">Add address</span>
        </button>
      </div>
    </div>
    <div class="header-bottom">
      <div class="search-bar">
        <i class="ri-search-line"></i>
        <input type="search" id="searchInput" placeholder="Search groceries...">
      </div>
      <div class="action-icons">
        <button class="icon-btn" id="filterBtn"><i class="ri-equalizer-line"></i></button>
        <button class="icon-btn" id="cartBtn">
          <i class="ri-shopping-cart-line"></i>
          <span class="cart-badge" id="cart-count" style="display:none;">0</span>
        </button>
        <a class="icon-btn" href="login.html"><i class="ri-user-line"></i></a>
      </div>
    </div>
  </div>
</header>
 
<div class="category-bar" id="categoryBar">
  <div class="category active">All</div>
  <div class="category">Vegetables</div>
  <div class="category">Fruits</div>
  <div class="category">Dairy and Bakery</div>
  <div class="category">Oils</div>
  <div class="category">Beverages</div>
  <div class="category">Grocery</div>
  <div class="category">Snacks</div>
  <div class="category">Personal Care</div>
  <div class="category">Frozen</div>
</div>

<section id="feed" class="market-feed"></section>

<div class="cart-backdrop" id="cartBackdrop"></div>
<aside class="side-cart" id="cartView">
  <div class="cart-header">
    <i class="ri-arrow-left-line" id="closeCart"></i>
    <span>Your Cart</span>
  </div>
  <div class="cart-body" id="cartItems"></div>
  <div class="cart-footer">
    <div class="total-row">
      <span>Total</span>
      <strong id="cartTotal">₹0</strong>
    </div>
    <button class="checkout-btn" id="placeOrderBtn">Place Order</button>
  </div>
</aside>

<div class="address-backdrop" id="addressBackdrop"></div>
<div class="address-modal" id="addressModal">
  <div class="address-header">
    <span>Delivery Address</span>
    <i class="ri-close-line" id="closeAddress"></i>
  </div>
  <div class="address-body">
    <input id="addrHouse" placeholder="House / Flat No.">
    <input id="addrStreet" placeholder="Area / Street">
    <input id="addrCity" value="Bengaluru" readonly>
    <input id="addrPin" placeholder="Pincode">
  </div>
  <div class="address-footer">
    <button id="saveAddressBtn">Save & Continue</button>
  </div>
</div>

<div id="successToast" class="success-toast">Order Placed Successfully!</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

  const supabase = createClient(
    'https://nfdrnbikwzfmijrqmoqt.supabase.co',
    'sb_publishable_dVvOYAqamp2BGoI8zvyB5g_NfCSkQ6b'
  )

  let products = []
  let filtered = []
  let cart = JSON.parse(localStorage.getItem('cart')) || []

  const ui = {
    feed: document.getElementById('feed'),
    cartCount: document.getElementById('cart-count'), 
    cartItems: document.getElementById('cartItems'),
    cartTotal: document.getElementById('cartTotal'),
    cartView: document.getElementById('cartView'),
    cartBackdrop: document.getElementById('cartBackdrop'),
    placeOrderBtn: document.getElementById('placeOrderBtn'),
    addrDisplay: document.getElementById('addrDisplay'),
    addressModal: document.getElementById('addressModal'),
    addressBackdrop: document.getElementById('addressBackdrop')
  };

  async function fetchProducts() {
    try {
      const { data, error } = await supabase.from('products').select('*').limit(100)
      if (error) throw error
      products = data.map(p => ({
        id: p.id,
        title: p.title || p.name || 'Product',
        price: p.price || 0,
        image: p.image || 'https://via.placeholder.com/300?text=No+Image',
        category: canonicalCategory(p.category),
        vendor_id: p.vendor_id || null
      }))
      filtered = [...products]
      renderProducts(); 
      updateBadge();
      loadSavedAddress();
    } catch (e) {
      console.error("Fetch error:", e)
    }
  }

  function canonicalCategory(cat){
    const s = (cat||'').toLowerCase();
    if (s.includes('fruit')) return 'Fruits';
    if (s.includes('veget')) return 'Vegetables';
    if (s.includes('dairy') || s.includes('milk')) return 'Dairy and Bakery';
    return 'Grocery';
  }

  function renderProducts(){
    ui.feed.innerHTML = ''
    const categories = [...new Set(filtered.map(p => p.category))]
    
    categories.forEach(cat => {
      const items = filtered.filter(p => p.category === cat)
      const sec = el('section', {class:'feed-section'}, [
        el('h3', {class:'feed-title'}, [cat]),
        el('div', {class:'product-grid'}, items.map(p => productCard(p)))
      ])
      ui.feed.appendChild(sec)
    })
  }

function productCard(p){
    // This fallback ensures that even if the URL is broken, the UI doesn't look empty
    const fallbackImage = 'https://placehold.co/400x400?text=Product+Image';

    return el('div', {class:'product-card'}, [
      el('div', {class:'p-img-wrapper'}, [
        el('img', {
          class:'p-img', 
          src: p.image, 
          loading: 'lazy',
          // If the image fails to load, use the fallback
          onerror: (e) => { e.target.src = fallbackImage } 
        })
      ]),
      el('div', {class:'p-info'}, [
        el('div', {class:'p-title', innerHTML: p.title}),
        el('div', {class:'p-meta'}, [
          el('span', {innerHTML: `₹${p.price}`}),
          el('button', {class:'add-btn', onclick: () => addToCart(p), innerHTML: 'Add'})
        ])
      ])
    ])
  }

  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v]) => k === 'onclick' ? n.onclick = v : n[k] = v);
    (Array.isArray(children) ? children : [children]).forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
    return n;
  }

  window.addToCart = (p) => {
    const idx = cart.findIndex(i => i.id === p.id)
    if(idx > -1) cart[idx].qty++
    else cart.push({...p, qty: 1})
    saveCart(); updateBadge();
  }

  function saveCart() { localStorage.setItem('cart', JSON.stringify(cart)); }

  function updateBadge() {
    const total = cart.reduce((s, i) => s + i.qty, 0)
    ui.cartCount.innerText = total
    ui.cartCount.style.display = total > 0 ? 'grid' : 'none'
  }

  function renderCart() {
    ui.cartItems.innerHTML = cart.length ? '' : '<div class="empty-cart-msg">Your cart is empty</div>'
    let total = 0
    cart.forEach(item => {
      total += item.price * item.qty
      ui.cartItems.appendChild(el('div', {class:'cart-row'}, [
        el('span', {innerHTML: `${item.title} x${item.qty}`}),
        el('span', {innerHTML: `₹${item.price * item.qty}`})
      ]))
    })
    ui.cartTotal.innerText = `₹${total}`
  }

  async function placeOrder() {
    const savedAddress = JSON.parse(localStorage.getItem('grokly_address'));
    if (!savedAddress || !savedAddress.street) {
      ui.addressModal.classList.add('show');
      ui.addressBackdrop.classList.add('show');
      return;
    }
    if (cart.length === 0) return;

    ui.placeOrderBtn.disabled = true;
    ui.placeOrderBtn.innerText = "Processing...";
    ui.cartView.classList.add('order-processing');

    const orderPayload = {
      items: cart,
      total_amount: cart.reduce((s, i) => s + (i.price * i.qty), 0),
      address: savedAddress,
      status: 'pending'
    };

    try {
      const { error } = await supabase.from('orders').insert([orderPayload]);
      if (error) throw error;
      cart = []; saveCart(); updateBadge();
      ui.cartView.classList.remove('show');
      ui.cartBackdrop.classList.remove('show');
      const toast = document.getElementById('successToast');
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    } catch (err) {
      alert("Error: " + err.message);
    } finally {
      ui.placeOrderBtn.disabled = false;
      ui.placeOrderBtn.innerText = "Place Order";
      ui.cartView.classList.remove('order-processing');
    }
  }

  ui.placeOrderBtn.onclick = placeOrder;
  
  document.getElementById('cartBtn').onclick = () => { 
    renderCart(); 
    ui.cartView.classList.add('show'); 
    ui.cartBackdrop.classList.add('show'); 
  };

  document.getElementById('closeCart').onclick = () => { 
    ui.cartView.classList.remove('show'); 
    ui.cartBackdrop.classList.remove('show'); 
  };

  document.getElementById('addressBtn').onclick = () => {
    ui.addressModal.classList.add('show');
    ui.addressBackdrop.classList.add('show');
  };

  document.getElementById('closeAddress').onclick = () => {
    ui.addressModal.classList.remove('show');
    ui.addressBackdrop.classList.remove('show');
  };

  document.getElementById('saveAddressBtn').onclick = () => {
    const addr = { 
      house: document.getElementById('addrHouse').value, 
      street: document.getElementById('addrStreet').value, 
      pincode: document.getElementById('addrPin').value,
      city: 'Bengaluru' 
    };
    if(!addr.street || !addr.house) return alert("Please fill address details");
    
    localStorage.setItem('grokly_address', JSON.stringify(addr));
    ui.addrDisplay.innerText = addr.street;
    ui.addressModal.classList.remove('show');
    ui.addressBackdrop.classList.remove('show');
  };

  function loadSavedAddress() {
    const saved = JSON.parse(localStorage.getItem('grokly_address'));
    if(saved) ui.addrDisplay.innerText = saved.street || "Saved Address";
  }

  fetchProducts();
</script>
</main>
</body>
</html>